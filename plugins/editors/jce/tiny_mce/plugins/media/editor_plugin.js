(function(){var each=tinymce.each;tinymce.create('tinymce.plugins.MediaPlugin',{init:function(ed,url){var t=this;this.mimes={};(function(data){var items=data.split(/,/),i,y,ext;for(i=0;i<items.length;i+=2){ext=items[i+1].split(/ /);for(y=0;y<ext.length;y++)t.mimes[ext[y]]=items[i]}})("application/pdf,pdf,"+"application/x-shockwave-flash,swf swfl,"+"audio/mpeg,mpga mpega mp2 mp3,"+"audio/ogg,ogg spx oga,"+"audio/x-wav,wav,"+"video/mpeg,mpeg mpg mpe,"+"video/mp4,mp4 m4v,"+"video/ogg,ogg ogv,"+"video/webm,webm,"+"video/quicktime,qt mov,"+"video/x-flv,flv,"+"video/vnd.rn-realvideo,rv"+"video/3gpp,3gp"+"video/x-matroska,mkv");t.editor=ed;t.url=url;function isMediaElm(n){return/mceItem(Flash|ShockWave|WindowsMedia|QuickTime|RealMedia|DivX|Silverlight|Audio|Video|Generic)/.test(n.className)};ed.onPreInit.add(function(){ed.serializer.addRules('param[name|value|_mce_value]');ed.serializer.addRules('+audio[autoplay|controls|loop|preload|src],+video[autoplay|controls|loop|poster|preload|src|width|height],source[media|src|type]');ed.serializer.addRules('img[data-mce-json|*]')});ed.onNodeChange.add(function(ed,cm,n){cm.setActive('media',n.nodeName=='IMG'&&isMediaElm(n))});ed.onInit.add(function(){ed.selection.onSetContent.add(function(){t._spansToImgs(ed.getBody())});ed.selection.onBeforeSetContent.add(t._objectsToSpans,t);if(ed.settings.content_css!==false)ed.dom.loadCSS(url+"/css/content.css")});ed.onBeforeSetContent.add(t._objectsToSpans,t);ed.onSetContent.add(function(){t._spansToImgs(ed.getBody())});ed.onPreProcess.add(function(ed,o){var dom=ed.dom;if(o.set){t._spansToImgs(o.node)}if(o.get){each(dom.select('IMG',o.node),function(n){if(isMediaElm(n)){var ci,cb,mt,type;if(ed.getParam('media_use_script')){n.className=n.className.replace(/mceItem/g,'mceTemp');return}var cls=/mceItem(Flash|ShockWave|WindowsMedia|QuickTime|RealMedia|DivX|PDF|Silverlight|Audio|Video)/.exec(n.className);switch(cls[0]){case'mceItemFlash':ci='d27cdb6e-ae6d-11cf-96b8-444553540000';cb='http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version='+ed.getParam('media_version_flash','10,0,32,18');mt='application/x-shockwave-flash';break;case'mceItemShockWave':ci='166b1bca-3f9c-11cf-8075-444553540000';cb='http://download.macromedia.com/pub/shockwave/cabs/director/sw.cab#version='+ed.getParam('media_version_shockwave','11,0,0,458');mt='application/x-director';break;case'mceItemWindowsMedia':ci='6bf52a52-394a-11d3-b153-00c04f79faa6';cb='http://activex.microsoft.com/activex/controls/mplayer/en/nsmp2inf.cab#Version='+ed.getParam('media_version_windowsmedia','5,1,52,701');mt='application/x-mplayer2';break;case'mceItemQuickTime':ci='02bf25d5-8c17-4b23-bc80-d3488abddc6b';cb='http://www.apple.com/qtactivex/qtplugin.cab#version='+ed.getParam('media_version_quicktime','6,0,2,0');mt='video/quicktime';break;case'mceItemRealMedia':ci='cfcdaa03-8be4-11cf-b84b-0020afbbccfa';cb='http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version='+ed.getParam('media_version_realplayer','7,0,0,0');mt='audio/x-pn-realaudio-plugin';break;case'mceItemDivX':ci='67dabfbf-d0ab-41fa-9c46-cc0f21721616';cb='http://go.divx.com/plugin/DivXBrowserPlugin.cab';mt='video/divx';break;case'mceItemPDF':ci='ca8a9780-280d-11cf-a24d-444553540000';cb='';mt='application/pdf';break;case'mceItemSilverlight':ci='';cb='';mt='application/x-silverlight-2';break}dom.replace(t._buildObj({classid:ci,codebase:cb,type:mt},n),n)}})}});function getAttr(s,n){n=new RegExp(n+'=\"([^\"]+)\"','g').exec(s);return n?ed.dom.decode(n[1]):''};ed.onPostProcess.add(function(ed,o){o.content=o.content.replace(/_mce_value=/g,'value=');if(ed.getParam('media_use_script')){o.content=o.content.replace(/<img[^>]+>/g,function(im){var cl=getAttr(im,'class');if(/(mceTempFlash|mceTempShockWave|mceTempWindowsMedia|mceTempQuickTime|mceTempRealMedia|mceTempDivX|mceTempAudio|mceTempVideo)/.test(cl)){at=t._parse(getAttr(im,'title'));at.width=getAttr(im,'width');at.height=getAttr(im,'height');im=cl.replace(/[\s\S]*?mceTemp(Flash|ShockWave|WindowsMedia|QuickTime|RealMedia|DivX|Silverlight|Audio|Video)[\s\S]*?/,function(a,b){return'<script type="text/javascript">JCEMediaObject.'+b.toLowerCase()+'({'+t._serialize(at)+'});</script>'})}return im})}if(o.get){var h=o.content;h=h.replace(/(\s|&nbsp;)?<source/gi,'<source');h=h.replace(/>(\s|&nbsp;)?<\/source>/gi,' />');o.content=h}})},getInfo:function(){return{longname:'Media',author:'Moxiecode Systems AB / Ryan Demmer',authorurl:'http://tinymce.moxiecode.com',infourl:'http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/media',version:'1.5.7.7'}},_objectsToSpans:function(ed,o){var t=this,ed=t.editor,h=o.content;function ucfirst(s){return s.charAt(0).toUpperCase()+s.substring(1)}h=h.replace(/<script[^>]*>([\s\S]*?)(write|JCEMediaObject\.)(Flash|ShockWave|WindowsMedia|QuickTime|RealMedia|DivX|Silverlight|Audio|Video)\(\{([^\)]*)\}\);([\s\S]*?)<\/script>/gi,function(a,b,c,d,e){var p=t._parse(e);return'<img class="mceItem'+ucfirst(d)+'" title="'+ed.dom.encode(e)+'" src="'+t.url+'/img/trans.gif" width="'+p.width+'" height="'+p.height+'" />'});h=h.replace(/<object([^>]*)>/gi,'<span class="mceItemObject" $1>');h=h.replace(/<(audio|video)([^>]*)>/gi,function(a,b,c){c=c.replace(/(autoplay|controls|loop|preload)(="\1")?/gi,'$1="$1"');c=c.replace(/type='([^"]+)'/gi,function(a,b){return'type="'+b.replace(/"/g,"'")+'"'});return'<span class="mceItem'+ucfirst(b)+'"'+c+'>'});h=h.replace(/<embed([^>]*)\/?>/gi,'<span class="mceItemEmbed" $1></span>');h=h.replace(/<embed([^>]*)>/gi,'<span class="mceItemEmbed" $1>');h=h.replace(/<\/(object|embed|audio|video)([^>]*)>/gi,'</span>');h=h.replace(/<param([^>]*)>/gi,function(a,b){return'<span '+b.replace(/value=/gi,'_mce_value=')+' class="mceItemParam"></span>'});h=h.replace(/<source([^>]*)>/gi,'<span$1 class="mceItemSource" /></span>');h=h.replace(/<\/source>/gi,'');h=h.replace(/\/ class=\"mceItemParam\"><\/span>/gi,'class="mceItemParam"></span>');o.content=h},_spansToImgs:function(p){var t=this,dom=t.editor.dom,mt,cl;each(dom.select('span.mceItemObject, span.mceItemEmbed, span.mceItemVideo, span.mceItemAudio',p),function(n){mt=dom.getAttrib(n,"classid")||dom.getAttrib(n,'type');if(!mt&&n.className=='mceItemObject'){each(n.childNodes,function(c){if(dom.hasClass(c,'mceItemEmbed'))mt=dom.getAttrib(c,'type')})}if(mt)mt=mt.toLowerCase().replace(/\s+/g,'');switch(mt){case'clsid:d27cdb6e-ae6d-11cf-96b8-444553540000':case'application/x-shockwave-flash':cl='mceItemFlash';break;case'clsid:166b1bca-3f9c-11cf-8075-444553540000':case'application/x-director':cl='mceItemShockWave';break;case'clsid:6bf52a52-394a-11d3-b153-00c04f79faa6':case'clsid:22d6f312-b0f6-11d0-94ab-0080c74c7e95':case'clsid:05589fa1-c356-11ce-bf01-00aa0055595a':case'application/x-mplayer2':cl='mceItemWindowsMedia';break;case'clsid:02bf25d5-8c17-4b23-bc80-d3488abddc6b':case'video/quicktime':cl='mceItemQuickTime';break;case'clsid:cfcdaa03-8be4-11cf-b84b-0020afbbccfa':case'audio/x-pn-realaudio-plugin':cl='mceItemRealMedia';break;case'clsid:67dabfbf-d0ab-41fa-9c46-cc0f21721616':case'video/divx':cl='mceItemDivX';break;case'clsid:ca8a9780-280d-11cf-a24d-444553540000':case'application/pdf':cl='mceItemPDF';break;case'application/x-silverlight-2':cl='mceItemSilverlight';break;default:cl='mceItemGeneric';break}dom.replace(t._createImg(cl,n),n);return})},_createImg:function(cl,n){var t=this,im,ed=this.editor,dom=ed.dom,pa={},ti='';im=dom.create('img',{src:this.url+'/img/trans.gif',width:dom.getAttrib(n,'width')||100,height:dom.getAttrib(n,'height')||100,style:dom.getAttrib(n,'style'),title:dom.getAttrib(n,'title'),'class':cl});dom.addClass(im,n.className);each(['bgcolor','align','border','vspace','hspace'],function(na){var v=dom.getAttrib(n,na);if(v){switch(na){case'bgcolor':dom.setStyle(im,'background-color',v);break;case'align':if(/^(left|right)$/.test(v)){dom.setStyle(im,'float',v)}else{dom.setStyle(im,'vertical-align',v)}break;case'vspace':dom.setStyle(im,'margin-top',v);dom.setStyle(im,'margin-bottom',v);break;case'hspace':dom.setStyle(im,'margin-left',v);dom.setStyle(im,'margin-right',v);break}}});var type=dom.getAttrib(n,'type'),src=dom.getAttrib(n,'src')||dom.getAttrib(n,'data');if(/mceItemObject/.test(n.className)){if(!type&&src){pa['type']=this.getMimeType(n.src)||''}each(['id','archive','codetype','declare','standby','type','usemap','lang','dir','tabindex','xml:lang'],function(na){var v=dom.getAttrib(n,na);if(v){pa[na]=v}});if(cl=='mceItemGeneric'){each(['type','classid','codebase','src'],function(na){var v=dom.getAttrib(n,na);if(v){pa[na]=v}})}if(pa.movie){pa.src=pa.movie;delete pa.movie}if(pa.source){pa.src=pa.source;delete pa.source}if(!pa.src){pa.src=pa.data;delete pa.data}each(dom.select('span.mceItemParam',n),function(p){var k=dom.getAttrib(p,'name'),v=dom.getAttrib(p,'_mce_value');if(v){if(k=='flashvars'){v=t._escape(v)}pa[k]=v}})}if(/mceItem(Audio|Video|Embed)/.test(n.className)){if(/mceItemEmbed/.test(n.className)){each(['bgcolor','flashvars','wmode','allowfullscreen','allowscriptaccess','quality','type'],function(na){var v=dom.getAttrib(n,na);if(v){pa[na]=v}})}else{if(fallback=dom.select('span.mceItemObject[type="application/x-shockwave-flash"]',n)){var s=[],fb={},el=fallback[0];each(['data'],function(na){var v=dom.getAttrib(el,na);if(v){fb[na]=v}});each(dom.select('span.mceItemParam',el),function(p){var k=dom.getAttrib(p,'name'),v=dom.getAttrib(p,'_mce_value');if(k&&v!=''){if(k=='flashvars'){v=t._escape(v)}fb[k]=v}});s.push(fb);pa['fallback']=fb}if(sources=dom.select('span.mceItemSource',n)){var s=[];each(sources,function(el){var at={};each(['type','src','media'],function(na){var v=dom.getAttrib(el,na);if(v){at[na]=v}});s.push(at)});if(s.length){pa['source']=s;delete pa.src}}dom.removeClass(im,'mceItemGeneric')}each(['title','autoplay','controls','loop','preload','src','contenteditable','contextmenu','draggable','hidden','item','itemprop','spellcheck','subject'],function(na){var v=dom.getAttrib(n,na);if(/(autoplay|controls|loop)/.test(na)){if(v){pa[na]=na}}else{if(v!=''){pa[na]=v}}})}var h='';each(n.childNodes,function(c){if(/mceItem(Audio|Video|Embed|Object|Param|Source)/.test(c.className))return;h+=dom.getOuterHTML(c)});if(h){pa['html']=dom.encode(h)}delete pa.width;delete pa.height;dom.setAttrib(im,'data-mce-json',this._serialize(pa));return im},_buildObj:function(o,n){var t=this,ob,ed=this.editor,dom=ed.dom,so,oh,type,node='object';var data=dom.getAttrib(n,'data-mce-json')||dom.getAttrib(n,'title');var p=this._parse(data);type=o.type||'';p.width=o.width=dom.getAttrib(n,'width')||100;p.height=o.height=dom.getAttrib(n,'height')||100;var args=['title','id','lang','dir','tabindex','xml:lang'];if(p.src)p.src=ed.convertURL(p.src,'src',n);if(p.flashvars)p.flashvars=this._unescape(p.flashvars);if(!type&&p.src){type=this.getMimeType(p.src)}var cls=/mceItem(Object|Embed|Audio|Video)/.exec(n.className);if(cls){node=cls[1].toLowerCase()}ob=dom.create('span',{style:dom.getAttrib(n,'style'),width:o.width,height:o.height,_mce_name:node});if(ed.dom.getParent(n,'span.mceItemObject, span.mceItemAudio, span.mceItemVideo')){return}switch(node){case'object':switch(o.type){case'application/x-silverlight-2':data='data:application/x-silverlight-2,';p.source=p.src;so=true;break;case'application/x-shockwave-flash':data=p.src;so=true;break}if(so&&ed.getParam('media_strict',true)){p.movie=p.src;delete p.src;tinymce.extend(attribs,{data:data,type:type});so=true}else{if(o.classid&&!p.classid){p.classid=o.classid}if(!/clsid:/.test(p.classid)){p.classid='clsid:'+p.classid}if(o.codebase&&!p.codebase){p.codebase=o.codebase}args=args.concat(args,['archive','classid','codebase','codetype','declare','data','standby','usemap']);each(args,function(na){dom.setAttrib(ob,na,p[na]);delete(p[na])});so=false}each(p,function(v,k){if(!/^(width|height|type)$/.test(k)){if(o.type=='application/x-mplayer2'&&k=='src'&&!p.url)k='url';if(v)dom.add(ob,'span',{_mce_name:'param',name:k,'_mce_value':v})}});if(p.url){p.src=p.url;delete p.url}if(!so){dom.add(ob,'span',tinymce.extend(p,{_mce_name:'embed',type:type}))}break;case'embed':case'audio':case'video':if(p.source){each(p.source,function(k){var src=ed.convertURL(k.src,'src',n);var type=k.type||t.getMimeType(src)||'';dom.add(ob,'span',tinymce.extend(p,{_mce_name:'source',type:type,src:src}))});delete p.src;delete p.type}else{args.push('src');if(node=='embed'){args.push('type')}}args=args.concat(args,['autoplay','controls','loop','preload','contenteditable','contextmenu','draggable','hidden','item','itemprop','spellcheck','subject']);each(args,function(na){v=p[na];if(/(autoplay|controls|loop)/.test(na)){if(v){v=na}}dom.setAttrib(ob,na,v)});if(p.object){var fb=p.object;var fbElm=dom.add(ob,'span',{_mce_name:'object',data:fb.data,width:n.width,height:n.height,type:'application/x-shockwave-flash'});if(fb.param){each(fb.param,function(v,k){dom.add(fbElm,'span',{_mce_name:'param',name:k,'_mce_value':v})})}}break}if(p.html){ob.innerHTML=tinymce.trim(ob.innerHTML)+tinymce.trim(dom.decode(p.html))}return ob},getMimeType:function(s){var ext;if(/\.([a-z0-9]{2,4})/.test(s)){ext=/\.([a-z0-9]{2,4})/.exec(s);ext=ext[1]||''}if(ext){return this.mimes[ext]}return false},_unescape:function(s){return decodeURIComponent(s).replace(/%27/g,"'")},_escape:function(s){return encodeURIComponent(s.replace(/'/g,'%27'))},_parse:function(s){s=/^{([\s\S]*?)}$/.test(s)?s:'{'+s+'}';return tinymce.util.JSON.parse(s)},_serialize:function(o){return tinymce.util.JSON.serialize(o)}});tinymce.PluginManager.add('media',tinymce.plugins.MediaPlugin)})();